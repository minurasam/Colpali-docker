version: '3.8'

services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ./qdrant_storage:/qdrant/storage
    restart: unless-stopped

  colpali-api:
    build: .
    container_name: colpali-api
    ports:
      - "8000:8000"
    volumes:
      # Cache models to avoid re-downloading
      - ~/.cache/huggingface:/root/.cache/huggingface
      # Optional: mount uploads directory to persist files
      - ./uploads:/app/uploads
    environment:
      - TRANSFORMERS_CACHE=/root/.cache/huggingface
      # === Local Qdrant Configuration ===
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      # === Qdrant Cloud Configuration (uncomment and set to use cloud) ===
      # - QDRANT_URL=https://your-cluster-url.cloud.qdrant.io:6333
      # - QDRANT_API_KEY=your-api-key-here
      # === Collection Configuration ===
      - COLLECTION_NAME=colpali_embeddings
    depends_on:
      - qdrant
    restart: unless-stopped
    # For GPU support (commented out for CPU-only mode)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]